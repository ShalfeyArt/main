<!DOCTYPE html>
<html lang="ru" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шалфей — Творческая мастерская</title>
    <link rel="icon" href="https://raw.githubusercontent.com/ShalfeyArt/main/refs/heads/main/shalfey.ico" type="image/x-icon">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* =========================================
           MATERIAL DESIGN 3 TOKEN SYSTEM
           ========================================= */
        :root {
            /* LIGHT THEME (Sage Green Seed) */
            --md-sys-color-primary: #4C662B;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #CDEDA3;
            --md-sys-color-on-primary-container: #102000;
            
            --md-sys-color-secondary: #586249;
            --md-sys-color-secondary-container: #DCE7C8;
            --md-sys-color-on-secondary-container: #151E0B;

            --md-sys-color-tertiary: #386663;
            --md-sys-color-tertiary-container: #BCECE7;
            --md-sys-color-on-tertiary-container: #00201E;

            --md-sys-color-surface: #FDFDF5;
            --md-sys-color-on-surface: #1B1C18;
            --md-sys-color-surface-variant: #E1E4D5;
            --md-sys-color-on-surface-variant: #44483D;
            --md-sys-color-outline: #75796C;
            --md-sys-color-outline-variant: #C5C8BA;

            --md-sys-color-surface-container-low: #F7F8EE;
            --md-sys-color-surface-container: #F1F2E8;
            --md-sys-color-surface-container-high: #ECECE2;

            --md-elevation-1: 0px 1px 3px 1px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-2: 0px 2px 6px 2px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --md-elevation-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.3);
        }

        html.dark {
            /* DARK THEME */
            --md-sys-color-primary: #B1D188;
            --md-sys-color-on-primary: #1F3701;
            --md-sys-color-primary-container: #354E16;
            --md-sys-color-on-primary-container: #CDEDA3;

            --md-sys-color-secondary: #C0CCAD;
            --md-sys-color-secondary-container: #404A33;
            --md-sys-color-on-secondary-container: #DCE7C8;

            --md-sys-color-tertiary: #A0D0CB;
            --md-sys-color-tertiary-container: #1F4E4B;
            --md-sys-color-on-tertiary-container: #BCECE7;

            --md-sys-color-surface: #13140F;
            --md-sys-color-on-surface: #E4E3DB;
            --md-sys-color-surface-variant: #44483D;
            --md-sys-color-on-surface-variant: #C5C8BA;
            --md-sys-color-outline: #8F9285;
            --md-sys-color-outline-variant: #44483D;

            --md-sys-color-surface-container-low: #1B1C18;
            --md-sys-color-surface-container: #1F201C;
            --md-sys-color-surface-container-high: #2A2B25;
            
            --md-elevation-1: 0px 1px 2px 0px rgba(0,0,0,0.3); 
            --md-elevation-2: 0px 2px 6px 2px rgba(0,0,0,0.3);
            --md-elevation-3: 0px 4px 8px 3px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: background-color 0.4s, color 0.4s;
            margin: 0; padding: 0; overflow-x: hidden;
        }

        h1, h2, h3, h4, .brand-font { font-family: 'Caveat', cursive; }

        /* --- COMPONENTS --- */

        /* Buttons */
        .md-btn {
            display: inline-flex; align-items: center; justify-content: center;
            border-radius: 9999px; height: 40px; padding: 0 24px;
            font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;
            letter-spacing: 0.1px; transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            cursor: pointer; overflow: hidden; position: relative; border: none;
        }
        .md-btn:active { transform: scale(0.98); }
        .md-btn-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: var(--md-elevation-1);
        }
        .md-btn-filled:hover { box-shadow: var(--md-elevation-2); filter: brightness(1.08); }
        .md-btn-tonal {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        .md-btn-tonal:hover { filter: brightness(0.95); box-shadow: var(--md-elevation-1); }
        .md-btn-text {
            background-color: transparent; color: var(--md-sys-color-on-surface-variant);
            padding: 0 16px;
        }
        .md-btn-text:hover { background-color: rgba(128,128,128, 0.1); color: var(--md-sys-color-on-surface); }

        /* Cards */
        .md-card {
            background-color: var(--md-sys-color-surface-container-low);
            border-radius: 24px; overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .md-card-elevated { box-shadow: var(--md-elevation-1); }
        html.dark .md-card-elevated { background-color: var(--md-sys-color-surface-container); border: 1px solid var(--md-sys-color-outline-variant); box-shadow: none; }
        .md-card:hover { transform: translateY(-4px); box-shadow: var(--md-elevation-2); }
        html.dark .md-card:hover { box-shadow: 0 0 0 1px var(--md-sys-color-outline); }

        /* Inputs */
        .md-input-group { position: relative; margin-bottom: 1rem; }
        .md-input {
            width: 100%; background: transparent; color: var(--md-sys-color-on-surface);
            border: 1px solid var(--md-sys-color-outline); border-radius: 8px;
            padding: 16px; font-size: 16px; outline: none; transition: 0.2s;
        }
        .md-input:focus { border-color: var(--md-sys-color-primary); border-width: 2px; padding: 15px; }
        .md-label {
            position: absolute; left: 16px; top: 16px; color: var(--md-sys-color-on-surface-variant);
            font-size: 16px; pointer-events: none; background-color: var(--md-sys-color-surface-container-low);
            padding: 0 4px; transition: 0.2s ease-out;
        }
        .md-input:focus ~ .md-label, .md-input:not(:placeholder-shown) ~ .md-label {
            top: -10px; font-size: 12px; color: var(--md-sys-color-primary); font-weight: 500;
        }

        /* FAB (Chat) */
        .md-fab {
            position: fixed; bottom: 24px; right: 24px;
            width: 56px; height: 56px; border-radius: 16px;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            box-shadow: var(--md-elevation-3);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
            z-index: 50;
        }
        .md-fab:hover { transform: scale(1.05); filter: brightness(1.05); }

        /* Chat Window */
        .chat-window {
            position: fixed; bottom: 90px; right: 24px;
            width: 360px; height: 500px; max-height: 80vh;
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: 28px;
            box-shadow: var(--md-elevation-3);
            display: flex; flex-direction: column;
            overflow: hidden; opacity: 0; pointer-events: none; transform: translateY(20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
            z-index: 50;
        }
        .chat-window.open { opacity: 1; pointer-events: auto; transform: translateY(0) scale(1); }
        
        .chat-bubble {
            max-width: 80%; padding: 10px 16px; border-radius: 18px;
            font-size: 14px; line-height: 1.4; margin-bottom: 8px; position: relative;
        }
        .chat-bubble.mine {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.theirs {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* Dialog/Modal */
        .md-dialog-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .md-dialog-overlay.open { opacity: 1; pointer-events: auto; }
        .md-dialog {
            background: var(--md-sys-color-surface-container-high);
            padding: 24px; border-radius: 28px; width: 90%; max-width: 400px;
            transform: scale(0.9); transition: transform 0.3s;
            box-shadow: var(--md-elevation-3);
        }
        .md-dialog-overlay.open .md-dialog { transform: scale(1); }

        /* Section Visibility */
        .page-section { display: none; animation: fadeIn 0.5s ease-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Star Rating */
        .star-rating { display: flex; gap: 4px; }
        .star-rating i {
            font-size: 2rem; color: var(--md-sys-color-outline-variant); cursor: pointer; transition: color 0.2s;
        }
        .star-rating i.active { color: #FBC02D; font-variation-settings: 'FILL' 1; }
        .star-rating i:hover, .star-rating i:hover ~ i { opacity: 0.8; }

        /* Preloader */
        #preloader { background-color: var(--md-sys-color-surface); }
        .sage-path { stroke: var(--md-sys-color-primary); stroke-dasharray: 1500; stroke-dashoffset: 1500; animation: draw 3s forwards; }
        @keyframes draw { to { stroke-dashoffset: 0; } }

    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <!-- =========== PRELOADER =========== -->
    <div id="preloader" class="fixed inset-0 z-[200] flex justify-center items-center transition-opacity duration-700">
        <svg class="w-32 h-32" viewBox="0 0 200 200">
            <path class="sage-path" d="M100 180 V 50 M100 130 C75 125 75 155 100 150 M100 130 C125 125 125 155 100 150 M100 100 C80 95 80 120 100 115 M100 100 C120 95 120 120 100 115 M100 75 C90 70 90 90 100 85 M100 75 C110 70 110 90 100 85 M80 160 a4,4 0 1,0 8,0 a4,4 0 1,0 -8,0 M120,165 a4,4 0 1,0 -8,0 a4,4 0 1,0 8,0 M75 90 a4,4 0 1,0 8,0 a4,4 0 1,0 -8,0" fill="none" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </div>

    <!-- =========== TOP APP BAR =========== -->
    <header id="top-bar" class="sticky top-0 z-50 w-full bg-[var(--md-sys-color-surface-container)] transition-shadow duration-300">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            
            <div class="flex items-center gap-2">
                <button id="mobile-menu-btn" class="md:hidden p-2 text-[var(--md-sys-color-on-surface)]"><span class="material-symbols-rounded">menu</span></button>
                <a href="#" class="flex items-center gap-3 group" onclick="showPage('home')">
                    <div class="h-10 w-10 rounded-full overflow-hidden shadow-sm border border-[var(--md-sys-color-outline-variant)]">
                        <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/main/2499.jpg" class="h-full w-full object-cover">
                    </div>
                    <span class="text-2xl brand-font font-bold text-[var(--md-sys-color-primary)]">Шалфей</span>
                </a>
            </div>
            
            <nav class="hidden md:flex items-center space-x-1">
                <button class="md-btn md-btn-text nav-link" onclick="showPage('home')">Главная</button>
                <button class="md-btn md-btn-text nav-link" onclick="showPage('rentals')">Аренда</button>
                <button class="md-btn md-btn-text nav-link" onclick="showPage('workshops')">Мастер-классы</button>
                <button class="md-btn md-btn-text nav-link" onclick="showPage('handmade')">Изделия</button>
                <button class="md-btn md-btn-text nav-link" onclick="showPage('reviews')">Отзывы</button>
                <button class="md-btn md-btn-text nav-link" onclick="showPage('contacts')">Контакты</button>
            </nav>

            <div class="flex items-center gap-2">
                <!-- Theme Toggle -->
                <button id="theme-toggle" class="p-2 rounded-full text-[var(--md-sys-color-on-surface-variant)] hover:bg-[var(--md-sys-color-surface-container-high)]">
                    <span class="material-symbols-rounded dark:hidden">dark_mode</span>
                    <span class="material-symbols-rounded hidden dark:block">light_mode</span>
                </button>
                
                <!-- Auth Button -->
                <div id="auth-container">
                    <button id="login-btn" class="md-btn md-btn-filled h-9 text-sm px-4">Войти</button>
                    <div id="user-profile" class="hidden relative group cursor-pointer">
                        <img id="user-avatar" src="" class="w-9 h-9 rounded-full border border-[var(--md-sys-color-outline)]">
                        <div class="absolute right-0 top-10 w-48 bg-[var(--md-sys-color-surface-container-high)] rounded-xl shadow-lg p-2 hidden group-hover:block z-50">
                            <div id="user-name" class="px-4 py-2 text-sm font-bold text-[var(--md-sys-color-on-surface)]">User</div>
                            <button id="logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-[var(--md-sys-color-surface-container)] rounded-lg">Выйти</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- =========== MOBILE DRAWER =========== -->
    <div id="mobile-drawer-overlay" class="fixed inset-0 bg-black/50 z-[60] hidden opacity-0 transition-opacity"></div>
    <aside id="mobile-menu" class="fixed top-0 left-0 bottom-0 w-[300px] z-[70] bg-[var(--md-sys-color-surface-container)] -translate-x-full transition-transform duration-300 p-4 shadow-xl rounded-r-[28px]">
        <div class="flex justify-between items-center mb-8">
            <span class="text-3xl brand-font text-[var(--md-sys-color-primary)]">Меню</span>
            <button id="close-menu-btn" class="p-2"><span class="material-symbols-rounded">close</span></button>
        </div>
        <nav class="flex flex-col gap-2">
            <button class="md-btn md-btn-text w-full justify-start text-lg h-12" onclick="showPage('home')">Главная</button>
            <button class="md-btn md-btn-text w-full justify-start text-lg h-12" onclick="showPage('rentals')">Аренда</button>
            <button class="md-btn md-btn-text w-full justify-start text-lg h-12" onclick="showPage('workshops')">Мастер-классы</button>
            <button class="md-btn md-btn-text w-full justify-start text-lg h-12" onclick="showPage('handmade')">Изделия</button>
            <button class="md-btn md-btn-text w-full justify-start text-lg h-12" onclick="showPage('reviews')">Отзывы</button>
            <button class="md-btn md-btn-text w-full justify-start text-lg h-12" onclick="showPage('contacts')">Контакты</button>
        </nav>
    </aside>

    <!-- =========== MAIN CONTENT =========== -->
    <main class="container mx-auto px-4 py-8 flex-grow">

        <!-- ===== HOME ===== -->
        <section id="home" class="page-section active">
            <div class="text-center mb-16">
                <h1 class="text-5xl md:text-7xl font-bold text-[var(--md-sys-color-primary)] mb-6">Природа и Творчество</h1>
                <p class="text-lg md:text-xl text-[var(--md-sys-color-on-surface-variant)] max-w-2xl mx-auto">Уникальные костюмы, душевные мастер-классы и уютные изделия ручной работы.</p>
                <div class="mt-8 flex justify-center gap-4">
                    <button class="md-btn md-btn-filled" onclick="showPage('rentals')">Смотреть костюмы</button>
                    <button class="md-btn md-btn-tonal" onclick="showPage('workshops')">Записаться на МК</button>
                </div>
            </div>
            
            <!-- Hero Images -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="h-80 rounded-[32px] overflow-hidden relative group cursor-pointer" onclick="showPage('rentals')">
                    <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/refs/heads/main/kostum%20krasny%20plasch%20eshe%20photo.jpg" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                    <div class="absolute inset-0 bg-black/40 flex items-end p-8"><h3 class="text-white text-4xl brand-font">Аренда</h3></div>
                </div>
                <div class="h-80 rounded-[32px] overflow-hidden relative group cursor-pointer" onclick="showPage('workshops')">
                    <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/main/Shkatulka%20samodel%20kak%20iz%20medi%20s%20masterclassa.jpg" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                    <div class="absolute inset-0 bg-black/40 flex items-end p-8"><h3 class="text-white text-4xl brand-font">Мастер-классы</h3></div>
                </div>
                <div class="h-80 rounded-[32px] overflow-hidden relative group cursor-pointer" onclick="showPage('handmade')">
                    <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/main/kluchnitsa%20dlya%20kluchey%20vvide%20domikov.jpg" class="w-full h-full object-cover transition duration-700 group-hover:scale-110">
                    <div class="absolute inset-0 bg-black/40 flex items-end p-8"><h3 class="text-white text-4xl brand-font">Изделия</h3></div>
                </div>
            </div>
        </section>

        <!-- ===== RENTALS (Simplified for brevity, same MD3 style) ===== -->
        <section id="rentals" class="page-section">
            <h2 class="text-5xl text-center brand-font text-[var(--md-sys-color-primary)] mb-8">Коллекция костюмов</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md-card md-card-elevated flex flex-col p-4">
                    <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/refs/heads/main/blackgold-demonstraciyanakidkiteploy.jpg" class="rounded-[20px] h-64 object-cover mb-4">
                    <h4 class="text-2xl brand-font">Темное золото</h4>
                    <p class="text-sm text-[var(--md-sys-color-on-surface-variant)] mt-2">Аренда: 800 ₽ / сутки</p>
                    <button class="md-btn md-btn-tonal mt-4 w-full" onclick="openChatWithProduct('Темное золото')">Забронировать в чате</button>
                </div>
                 <div class="md-card md-card-elevated flex flex-col p-4">
                    <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/main/kostum%20krasny%20plasch%20eshe%20photo.jpg" class="rounded-[20px] h-64 object-cover mb-4">
                    <h4 class="text-2xl brand-font">Красная мантия</h4>
                    <p class="text-sm text-[var(--md-sys-color-on-surface-variant)] mt-2">Аренда: 800 ₽ / сутки</p>
                    <button class="md-btn md-btn-tonal mt-4 w-full" onclick="openChatWithProduct('Красная мантия')">Забронировать в чате</button>
                </div>
                 <div class="md-card md-card-elevated flex flex-col p-4">
                    <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/refs/heads/main/vedmochka2.jpg" class="rounded-[20px] h-64 object-cover mb-4">
                    <h4 class="text-2xl brand-font">Лесная ведунья</h4>
                    <p class="text-sm text-[var(--md-sys-color-on-surface-variant)] mt-2">Аренда: 800 ₽ / сутки</p>
                    <button class="md-btn md-btn-tonal mt-4 w-full" onclick="openChatWithProduct('Лесная ведунья')">Забронировать в чате</button>
                </div>
            </div>
        </section>

        <!-- ===== WORKSHOPS ===== -->
        <section id="workshops" class="page-section">
            <h2 class="text-5xl text-center brand-font text-[var(--md-sys-color-primary)] mb-8">Творческие встречи</h2>
             <div class="space-y-6">
                <div class="md-card md-card-elevated p-6 flex flex-col md:flex-row gap-6 items-center">
                    <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/main/Shkatulka%20samodel%20kak%20iz%20medi%20s%20masterclassa.jpg" class="w-full md:w-1/3 rounded-[20px] h-64 object-cover">
                    <div class="flex-1">
                        <h3 class="text-3xl brand-font">Шкатулка "Медное сокровище"</h3>
                        <p class="mt-2 text-[var(--md-sys-color-on-surface-variant)]">Техники состаривания и имитации чеканки.</p>
                        <div class="mt-6 flex items-center justify-between">
                            <span class="text-xl font-bold text-[var(--md-sys-color-primary)]">1500 ₽</span>
                            <button class="md-btn md-btn-filled" onclick="openChatWithProduct('МК Шкатулка')">Записаться</button>
                        </div>
                    </div>
                </div>
             </div>
        </section>

        <!-- ===== HANDMADE ===== -->
        <section id="handmade" class="page-section">
            <h2 class="text-5xl text-center brand-font text-[var(--md-sys-color-primary)] mb-8">Ручная работа</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                 <div class="md-card md-card-elevated p-3">
                    <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/main/kluchnitsa%20dlya%20kluchey%20vvide%20domikov.jpg" class="rounded-[16px] h-48 w-full object-cover">
                    <h4 class="text-xl brand-font mt-2">Ключница</h4>
                    <span class="block font-bold text-[var(--md-sys-color-primary)]">1500 ₽</span>
                </div>
                <div class="md-card md-card-elevated p-3">
                    <img src="https://raw.githubusercontent.com/XtraDamage/Tonimage-/main/elochny%20igrushky%20vnutry.jpg" class="rounded-[16px] h-48 w-full object-cover">
                    <h4 class="text-xl brand-font mt-2">Игрушки</h4>
                    <span class="block font-bold text-[var(--md-sys-color-primary)]">1000 ₽</span>
                </div>
            </div>
        </section>

        <!-- ===== REVIEWS (FIRESTORE) ===== -->
        <section id="reviews" class="page-section">
            <div class="text-center mb-10">
                <h2 class="text-5xl brand-font text-[var(--md-sys-color-primary)]">Отзывы гостей</h2>
                <p class="text-[var(--md-sys-color-on-surface-variant)] mb-6">Настоящие истории наших посетителей</p>
                <button id="write-review-btn" class="md-btn md-btn-filled" onclick="openReviewModal()">
                    <span class="material-symbols-rounded mr-2">edit</span>
                    Оставить отзыв
                </button>
            </div>

            <!-- Reviews Grid -->
            <div id="reviews-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Reviews injected via JS -->
                <div class="col-span-full text-center py-10 text-[var(--md-sys-color-on-surface-variant)]">
                    <span class="material-symbols-rounded animate-spin text-3xl">refresh</span>
                    <p>Загрузка отзывов...</p>
                </div>
            </div>
        </section>

        <!-- ===== CONTACTS ===== -->
        <section id="contacts" class="page-section">
            <div class="text-center mb-12">
                <h2 class="text-5xl brand-font text-[var(--md-sys-color-primary)]">На связи</h2>
            </div>
            <div class="bg-[var(--md-sys-color-surface-container)] rounded-[32px] p-8 max-w-2xl mx-auto flex flex-col md:flex-row gap-8 items-center">
                 <div class="text-left space-y-4 flex-1">
                    <div class="flex items-center gap-3">
                        <span class="w-10 h-10 rounded-full bg-[var(--md-sys-color-surface)] flex items-center justify-center"><i class="fas fa-phone"></i></span>
                        <span>+7 (920) 322-62-63</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="w-10 h-10 rounded-full bg-[var(--md-sys-color-surface)] flex items-center justify-center"><i class="fas fa-map-marker-alt"></i></span>
                        <span>д. Станички, ул. Полевая 12</span>
                    </div>
                 </div>
                 <div class="flex gap-4">
                     <a href="https://vk.com/shalfeyart" target="_blank" class="md-btn md-btn-tonal w-12 h-12 p-0 rounded-full"><i class="fab fa-vk text-xl"></i></a>
                     <button onclick="document.getElementById('chat-fab').click()" class="md-btn md-btn-filled w-12 h-12 p-0 rounded-full"><i class="fas fa-comment text-xl"></i></button>
                 </div>
            </div>
        </section>

    </main>

    <!-- =========== CHAT WIDGET =========== -->
    <button id="chat-fab" class="md-fab">
        <span class="material-symbols-rounded text-2xl">chat</span>
        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center hidden" id="unread-badge">0</span>
    </button>

    <div id="chat-window" class="chat-window">
        <!-- Chat Header -->
        <div class="bg-[var(--md-sys-color-primary)] text-[var(--md-sys-color-on-primary)] p-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                    <span class="material-symbols-rounded text-sm">spa</span>
                </div>
                <div>
                    <h4 class="font-bold text-sm" id="chat-header-title">Чат с продавцом</h4>
                    <span class="text-xs opacity-80" id="chat-header-subtitle">Онлайн</span>
                </div>
            </div>
            <button onclick="toggleChat()" class="text-white hover:bg-white/10 rounded-full p-1"><span class="material-symbols-rounded">close</span></button>
        </div>
        
        <!-- Admin Chat List (Only visible to admin) -->
        <div id="admin-chat-list" class="hidden flex-col h-full bg-[var(--md-sys-color-surface-container)] overflow-y-auto">
            <!-- Items injected via JS -->
        </div>

        <!-- Chat Messages Area -->
        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto bg-[var(--md-sys-color-surface-container-high)] flex flex-col">
            <div class="text-center text-xs text-[var(--md-sys-color-outline)] mt-4">Напишите нам, мы ответим в ближайшее время.</div>
        </div>

        <!-- Input Area -->
        <div id="chat-input-area" class="p-3 bg-[var(--md-sys-color-surface)] border-t border-[var(--md-sys-color-outline-variant)] flex gap-2 items-center">
            <input type="text" id="chat-input" placeholder="Сообщение..." class="flex-grow bg-[var(--md-sys-color-surface-container-high)] border-none rounded-full px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--md-sys-color-primary)]">
            <button id="send-btn" class="w-10 h-10 rounded-full bg-[var(--md-sys-color-primary)] text-[var(--md-sys-color-on-primary)] flex items-center justify-center hover:shadow-md transition">
                <span class="material-symbols-rounded text-sm">send</span>
            </button>
        </div>
        
        <!-- Login Overlay for Chat -->
        <div id="chat-login-overlay" class="absolute inset-0 bg-[var(--md-sys-color-surface-container-high)] flex flex-col items-center justify-center p-6 text-center z-10">
            <span class="material-symbols-rounded text-4xl text-[var(--md-sys-color-primary)] mb-4">lock</span>
            <p class="mb-4 text-sm text-[var(--md-sys-color-on-surface-variant)]">Чтобы писать сообщения, пожалуйста, войдите в аккаунт.</p>
            <button onclick="login()" class="md-btn md-btn-filled">Войти через Google</button>
        </div>
    </div>

    <!-- =========== REVIEW MODAL =========== -->
    <div id="review-modal" class="md-dialog-overlay">
        <div class="md-dialog">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl brand-font text-[var(--md-sys-color-on-surface)]">Ваш отзыв</h3>
                <button onclick="closeReviewModal()" class="p-1"><span class="material-symbols-rounded">close</span></button>
            </div>
            
            <div class="flex flex-col items-center gap-2 mb-6">
                <p class="text-sm text-[var(--md-sys-color-on-surface-variant)]">Оцените нас</p>
                <div class="star-rating" id="modal-stars">
                    <i class="material-symbols-rounded" data-value="1">star</i>
                    <i class="material-symbols-rounded" data-value="2">star</i>
                    <i class="material-symbols-rounded" data-value="3">star</i>
                    <i class="material-symbols-rounded" data-value="4">star</i>
                    <i class="material-symbols-rounded" data-value="5">star</i>
                </div>
            </div>

            <div class="md-input-group">
                <textarea id="review-text" rows="4" class="md-input peer" placeholder=" "></textarea>
                <label class="md-label">Текст отзыва</label>
            </div>

            <button onclick="submitReview()" class="md-btn md-btn-filled w-full">Отправить</button>
        </div>
    </div>

    <!-- =========== FIREBASE & LOGIC =========== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, query, orderBy, addDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyA8roOb63vM_ZaBt11x8B1b132gQBiG29A",
            authDomain: "shalf-aad46.firebaseapp.com",
            projectId: "shalf-aad46",
            storageBucket: "shalf-aad46.firebasestorage.app",
            messagingSenderId: "131850620388",
            appId: "1:131850620388:web:1afd6733af73f96af0cbf1",
            measurementId: "G-XN22P9DJBZ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const APP_ID = 'shalf-aad46'; // Using projectId as identifier for structure
        let currentUser = null;
        let isAdmin = false;
        let activeChatId = null; // For admin to know which chat is open
        let chatUnsubscribe = null; // To stop listening when switching chats

        // --- AUTH LOGIC ---
        const loginBtn = document.getElementById('login-btn');
        const userProfile = document.getElementById('user-profile');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-btn');
        const chatLoginOverlay = document.getElementById('chat-login-overlay');

        window.login = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
                alert("Ошибка входа: " + error.message);
            }
        };

        logoutBtn.addEventListener('click', () => signOut(auth));
        loginBtn.addEventListener('click', window.login);

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                loginBtn.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userAvatar.src = user.photoURL;
                userName.textContent = user.displayName;
                chatLoginOverlay.classList.add('hidden');
                
                // Check Admin Status
                checkAdminStatus(user.uid);
                
                // Load user review if exists to populate modal
                // loadUserReviewDraft(); 
            } else {
                loginBtn.classList.remove('hidden');
                userProfile.classList.add('hidden');
                chatLoginOverlay.classList.remove('hidden');
                isAdmin = false;
                resetChatUI();
            }
            loadReviews(); // Reload to update "Edit" buttons capability
        });

        async function checkAdminStatus(uid) {
            // Check if user document exists in 'admins' collection
            const adminDoc = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'admins', uid));
            if (adminDoc.exists()) {
                isAdmin = true;
                console.log("Admin Logged In");
                setupAdminChat();
            } else {
                isAdmin = false;
                setupCustomerChat();
            }
        }

        // --- REVIEWS LOGIC ---
        const reviewsContainer = document.getElementById('reviews-container');
        const reviewModal = document.getElementById('review-modal');
        const modalStars = document.querySelectorAll('#modal-stars i');
        let currentRating = 5;

        // Render Stars Interaction
        modalStars.forEach(star => {
            star.addEventListener('click', () => {
                currentRating = parseInt(star.dataset.value);
                updateStarVisuals(currentRating);
            });
        });

        function updateStarVisuals(rating) {
            modalStars.forEach(s => {
                if (parseInt(s.dataset.value) <= rating) {
                    s.classList.add('active', 'text-yellow-500');
                    s.textContent = 'star'; // filled
                } else {
                    s.classList.remove('active', 'text-yellow-500');
                    s.textContent = 'star'; // outline handled by font settings or color
                    s.style.fontVariationSettings = "'FILL' 0";
                }
                if (parseInt(s.dataset.value) <= rating) s.style.fontVariationSettings = "'FILL' 1";
            });
        }

        window.openReviewModal = () => {
            if (!currentUser) {
                window.login();
                return;
            }
            // Prefill if existing
            const existingReview = document.getElementById(`review-card-${currentUser.uid}`);
            if(existingReview) {
                // Parse existing data from DOM (or better, fetch from DB, but DOM is faster for simple apps)
                const text = existingReview.querySelector('.review-text').textContent;
                const stars = existingReview.querySelectorAll('.material-symbols-rounded.text-yellow-500').length;
                document.getElementById('review-text').value = text;
                currentRating = stars;
                updateStarVisuals(currentRating);
            } else {
                document.getElementById('review-text').value = '';
                currentRating = 5;
                updateStarVisuals(5);
            }
            reviewModal.classList.add('open');
        };

        window.closeReviewModal = () => reviewModal.classList.remove('open');

        window.submitReview = async () => {
            const text = document.getElementById('review-text').value;
            if (!text.trim()) return alert("Напишите хоть пару слов!");

            const reviewData = {
                userId: currentUser.uid,
                displayName: currentUser.displayName,
                photoURL: currentUser.photoURL,
                rating: currentRating,
                text: text,
                timestamp: serverTimestamp()
            };

            try {
                // Save to: artifacts/{appId}/public/data/reviews/{userId}
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'reviews', currentUser.uid), reviewData);
                closeReviewModal();
                loadReviews(); // Refresh list
            } catch (e) {
                console.error("Error saving review", e);
                alert("Ошибка сохранения.");
            }
        };

        async function loadReviews() {
            reviewsContainer.innerHTML = '<div class="col-span-full text-center py-4 opacity-50">Обновление...</div>';
            
            const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'reviews'), orderBy('timestamp', 'desc'));
            const querySnapshot = await getDocs(q);
            
            reviewsContainer.innerHTML = '';
            
            if (querySnapshot.empty) {
                reviewsContainer.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">Пока нет отзывов. Станьте первым!</div>';
                return;
            }

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const isMine = currentUser && data.userId === currentUser.uid;
                
                // Generate Stars HTML
                let starsHtml = '';
                for(let i=1; i<=5; i++) {
                    starsHtml += `<span class="material-symbols-rounded text-lg ${i <= data.rating ? 'text-yellow-500' : 'text-gray-300'}" style="font-variation-settings: 'FILL' ${i<=data.rating ? 1 : 0}">star</span>`;
                }

                const cardHtml = `
                    <div id="review-card-${data.userId}" class="md-card md-card-elevated p-6 flex flex-col h-full bg-[var(--md-sys-color-surface-container-low)]">
                        <div class="flex items-center gap-4 mb-4">
                            <img src="${data.photoURL || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full">
                            <div>
                                <h4 class="font-bold text-sm text-[var(--md-sys-color-on-surface)]">${data.displayName}</h4>
                                <div class="flex">${starsHtml}</div>
                            </div>
                            ${isMine ? '<span class="ml-auto text-xs bg-[var(--md-sys-color-primary-container)] px-2 py-1 rounded text-[var(--md-sys-color-on-primary-container)]">Ваш отзыв</span>' : ''}
                        </div>
                        <p class="text-[var(--md-sys-color-on-surface-variant)] text-sm italic review-text flex-grow">"${data.text}"</p>
                    </div>
                `;
                reviewsContainer.innerHTML += cardHtml;
            });
        }

        // --- CHAT LOGIC ---
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const adminChatList = document.getElementById('admin-chat-list');
        const chatHeaderTitle = document.getElementById('chat-header-title');
        const chatHeaderSubtitle = document.getElementById('chat-header-subtitle');

        window.toggleChat = () => {
            chatWindow.classList.toggle('open');
            // Scroll to bottom
            setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 100);
        };

        window.openChatWithProduct = (productName) => {
            if(!currentUser) {
                window.login().then(() => {
                    toggleChat();
                    chatInput.value = `Здравствуйте! Меня интересует ${productName}.`;
                });
            } else {
                toggleChat();
                chatInput.value = `Здравствуйте! Меня интересует ${productName}.`;
            }
        };

        function resetChatUI() {
            chatMessages.innerHTML = '';
            adminChatList.classList.add('hidden');
            chatInput.disabled = true;
        }

        // 1. Customer Mode
        function setupCustomerChat() {
            activeChatId = currentUser.uid;
            chatHeaderTitle.textContent = "Чат с продавцом";
            chatHeaderSubtitle.textContent = "Обычно отвечаем в течение часа";
            chatInput.disabled = false;
            adminChatList.classList.add('hidden');
            chatMessages.classList.remove('hidden');
            chatInput.parentElement.classList.remove('hidden');

            listenToChat(activeChatId);
        }

        // 2. Admin Mode
        function setupAdminChat() {
            chatHeaderTitle.textContent = "Админ-панель";
            chatHeaderSubtitle.textContent = "Выберите диалог";
            adminChatList.classList.remove('hidden');
            chatMessages.classList.add('hidden'); // Hide messages until chat selected
            chatInput.parentElement.classList.add('hidden');
            
            // Listen to ALL chats (In a real app, query by 'lastUpdated')
            // Using a simple list of documents in 'chats' collection
            const q = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats'), orderBy('lastUpdated', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                adminChatList.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = "p-4 border-b border-[var(--md-sys-color-outline-variant)] hover:bg-[var(--md-sys-color-surface-container-high)] cursor-pointer flex justify-between items-center";
                    item.innerHTML = `
                        <div>
                            <div class="font-bold text-sm">${data.userName || 'User'}</div>
                            <div class="text-xs text-[var(--md-sys-color-on-surface-variant)] truncate w-48">${data.lastMessage}</div>
                        </div>
                        <span class="text-[10px] opacity-50">${data.lastUpdated ? new Date(data.lastUpdated.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}</span>
                    `;
                    item.onclick = () => openAdminChat(doc.id, data.userName);
                    adminChatList.appendChild(item);
                });
            });
        }

        function openAdminChat(userId, userName) {
            activeChatId = userId;
            chatHeaderTitle.textContent = userName;
            chatHeaderSubtitle.textContent = "Клиент";
            
            adminChatList.classList.add('hidden');
            chatMessages.classList.remove('hidden');
            chatInput.parentElement.classList.remove('hidden');
            
            // Add back button logic to header if needed, for now toggle closes app
            
            listenToChat(userId);
        }

        // Common Listener
        function listenToChat(chatId) {
            if(chatUnsubscribe) chatUnsubscribe();
            
            const messagesRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'chats', chatId, 'messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'));

            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                chatMessages.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMine = msg.senderId === currentUser.uid;
                    
                    const bubble = document.createElement('div');
                    bubble.className = `chat-bubble ${isMine ? 'mine' : 'theirs'}`;
                    bubble.textContent = msg.text;
                    chatMessages.appendChild(bubble);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // Send Message
        async function sendMessage() {
            const text = chatInput.value.trim();
            if(!text || !activeChatId || !currentUser) return;

            chatInput.value = '';

            const chatDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'chats', activeChatId);
            const messagesColRef = collection(chatDocRef, 'messages');

            try {
                // 1. Add message
                await addDoc(messagesColRef, {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    timestamp: serverTimestamp()
                });

                // 2. Update chat meta data (for Admin list)
                // If I am customer, I set my name. If I am admin, I don't overwrite user name.
                const updateData = {
                    lastMessage: text,
                    lastUpdated: serverTimestamp()
                };
                
                if (!isAdmin) {
                    updateData.userName = currentUser.displayName;
                    updateData.userId = currentUser.uid;
                }

                await setDoc(chatDocRef, updateData, { merge: true });

            } catch (error) {
                console.error("Error sending", error);
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

        // --- GENERAL UI ---
        // Preloader
        document.addEventListener('DOMContentLoaded', () => {
             setTimeout(() => {
                document.getElementById('preloader').classList.add('opacity-0', 'pointer-events-none');
            }, 2500);
            
            loadReviews(); // Initial load (read-only)
        });

        // Page Navigation
        window.showPage = (pageId) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            const active = document.getElementById(pageId);
            if(active) active.classList.add('active');
            
            document.getElementById('mobile-menu').classList.add('-translate-x-full');
            document.getElementById('mobile-drawer-overlay').classList.add('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        // Theme Toggle
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const html = document.documentElement;
            if(html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
            } else {
                html.classList.add('dark');
                html.classList.remove('light');
            }
        });

        // Mobile Menu
        document.getElementById('mobile-menu-btn').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.remove('-translate-x-full');
            document.getElementById('mobile-drawer-overlay').classList.remove('hidden', 'opacity-0');
        });
        document.getElementById('close-menu-btn').addEventListener('click', () => {
             document.getElementById('mobile-menu').classList.add('-translate-x-full');
             document.getElementById('mobile-drawer-overlay').classList.add('hidden');
        });
        document.getElementById('mobile-drawer-overlay').addEventListener('click', () => {
             document.getElementById('mobile-menu').classList.add('-translate-x-full');
             document.getElementById('mobile-drawer-overlay').classList.add('hidden');
        });

    </script>
</body>
</html>
